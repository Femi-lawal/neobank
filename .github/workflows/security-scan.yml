name: Security Scan

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    schedule:
        - cron: "0 6 * * 1" # Weekly on Monday

jobs:
    dependency-scan:
        name: Dependency Vulnerability Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Run Snyk to check for vulnerabilities (Go)
              uses: snyk/actions/golang@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --all-projects --severity-threshold=high

            - name: Run Snyk to check for vulnerabilities (Node)
              uses: snyk/actions/node@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --severity-threshold=high
                  command: test

    container-scan:
        name: Container Security Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Build identity-service image
              run: docker build -t neobank/identity-service:scan ./backend/identity-service

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "neobank/identity-service:scan"
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    sast-scan:
        name: Static Application Security Testing
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Run Semgrep SAST
              uses: returntocorp/semgrep-action@v1
              with:
                  config: >-
                      p/security-audit
                      p/secrets
                      p/owasp-top-ten
                      p/golang
                      p/typescript

    secret-scan:
        name: Secret Detection
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect secrets with Gitleaks
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    license-scan:
        name: License Compliance
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Check licenses
              uses: fossas/fossa-action@main
              continue-on-error: true
              with:
                  api-key: ${{ secrets.FOSSA_API_KEY }}
