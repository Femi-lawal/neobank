# Istio VirtualService with retry and timeout policies
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: identity-service-vs
  namespace: neobank
spec:
  hosts:
    - neobank-identity-service
  http:
    - route:
        - destination:
            host: neobank-identity-service
            port:
              number: 8081
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: connect-failure,refused-stream,unavailable,cancelled,retriable-4xx,reset,5xx
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ledger-service-vs
  namespace: neobank
spec:
  hosts:
    - neobank-ledger-service
  http:
    - route:
        - destination:
            host: neobank-ledger-service
            port:
              number: 8082
      timeout: 45s
      retries:
        attempts: 3
        perTryTimeout: 15s
        retryOn: connect-failure,refused-stream,unavailable,cancelled,reset
      # Don't retry 5xx for ledger to avoid duplicate transactions
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: payment-service-vs
  namespace: neobank
spec:
  hosts:
    - neobank-payment-service
  http:
    - match:
        - headers:
            x-idempotency-key:
              regex: ".+"
      route:
        - destination:
            host: neobank-payment-service
            port:
              number: 8083
      timeout: 60s
      retries:
        attempts: 3
        perTryTimeout: 20s
        retryOn: connect-failure,refused-stream,unavailable,cancelled,reset
    - route:
        - destination:
            host: neobank-payment-service
            port:
              number: 8083
      timeout: 60s
      retries:
        attempts: 1
        perTryTimeout: 55s
        retryOn: connect-failure,refused-stream,unavailable
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: card-service-vs
  namespace: neobank
spec:
  hosts:
    - neobank-card-service
  http:
    - route:
        - destination:
            host: neobank-card-service
            port:
              number: 8085
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: connect-failure,refused-stream,unavailable,cancelled,reset,5xx
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: product-service-vs
  namespace: neobank
spec:
  hosts:
    - neobank-product-service
  http:
    - route:
        - destination:
            host: neobank-product-service
            port:
              number: 8084
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: connect-failure,refused-stream,unavailable,cancelled,reset,5xx
