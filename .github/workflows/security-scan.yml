name: Security Scan

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    schedule:
        - cron: "0 6 * * 1" # Weekly on Monday

permissions:
    contents: read
    security-events: write
    actions: read

jobs:
    dependency-scan:
        name: Dependency Vulnerability Scan
        runs-on: ubuntu-latest
        # Continue even if this job fails (optional SNYK_TOKEN)
        continue-on-error: true
        steps:
            - uses: actions/checkout@v4

            - name: Check if Snyk token is available
              id: snyk-check
              run: |
                  if [ -n "${{ secrets.SNYK_TOKEN }}" ]; then
                    echo "available=true" >> $GITHUB_OUTPUT
                  else
                    echo "available=false" >> $GITHUB_OUTPUT
                    echo "::warning::SNYK_TOKEN not configured. Skipping Snyk scan."
                  fi

            - name: Run Snyk to check for vulnerabilities (Go)
              if: steps.snyk-check.outputs.available == 'true'
              uses: snyk/actions/golang@master
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --all-projects --severity-threshold=high
              continue-on-error: true

            - name: Run Snyk to check for vulnerabilities (Node)
              if: steps.snyk-check.outputs.available == 'true'
              uses: snyk/actions/node@master
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --severity-threshold=high
                  command: test
              continue-on-error: true

    container-scan:
        name: Container Security Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Build identity-service image
              working-directory: backend
              run: |
                  # Use backend/ as context since Dockerfile references go.work and shared-lib
                  docker build -t neobank/identity-service:scan -f identity-service/Dockerfile .

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "neobank/identity-service:scan"
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    sast-scan:
        name: Static Application Security Testing
        runs-on: ubuntu-latest
        continue-on-error: true
        steps:
            - uses: actions/checkout@v4

            - name: Run Semgrep SAST
              uses: returntocorp/semgrep-action@v1
              with:
                  config: >-
                      p/security-audit
                      p/secrets
                      p/owasp-top-ten
                      p/golang
                      p/typescript
              continue-on-error: true

    secret-scan:
        name: Secret Detection
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect secrets with Gitleaks
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GITLEAKS_CONFIG: .gitleaks.toml

    license-scan:
        name: License Compliance
        runs-on: ubuntu-latest
        # License scanning is optional - requires FOSSA_API_KEY
        continue-on-error: true
        steps:
            - uses: actions/checkout@v4

            - name: Check if FOSSA key is available
              id: fossa-check
              run: |
                  if [ -n "${{ secrets.FOSSA_API_KEY }}" ]; then
                    echo "available=true" >> $GITHUB_OUTPUT
                  else
                    echo "available=false" >> $GITHUB_OUTPUT
                    echo "::warning::FOSSA_API_KEY not configured. Skipping license scan."
                  fi

            - name: Check licenses
              if: steps.fossa-check.outputs.available == 'true'
              uses: fossas/fossa-action@main
              with:
                  api-key: ${{ secrets.FOSSA_API_KEY }}
