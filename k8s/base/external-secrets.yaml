# External Secrets for NeoBank
# Uses AWS Secrets Manager as the secret store
# Requires External Secrets Operator to be installed in the cluster
---
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: neobank
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      # Uses IRSA (IAM Roles for Service Accounts) for authentication
      # No explicit credentials needed when running in EKS with proper IAM setup
---
# Main application secrets from AWS Secrets Manager
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: neobank-secrets
  namespace: neobank
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: neobank-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        db-user: "{{ .db_user }}"
        db-password: "{{ .db_password }}"
        db-name: "{{ .db_name }}"
        jwt-secret: "{{ .jwt_secret }}"
        redis-password: "{{ .redis_password }}"
  data:
    - secretKey: db_user
      remoteRef:
        key: neobank/database
        property: username
    - secretKey: db_password
      remoteRef:
        key: neobank/database
        property: password
    - secretKey: db_name
      remoteRef:
        key: neobank/database
        property: database
    - secretKey: jwt_secret
      remoteRef:
        key: neobank/auth
        property: secret
    - secretKey: redis_password
      remoteRef:
        key: neobank/cache
        property: password
---
# Database URL secret (constructed from individual values)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: neobank-db-url
  namespace: neobank
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: neobank-db-url
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        database-url: "postgresql://{{ .db_user }}:{{ .db_password }}@postgres:5432/{{ .db_name }}?sslmode=require"
  data:
    - secretKey: db_user
      remoteRef:
        key: neobank/database
        property: username
    - secretKey: db_password
      remoteRef:
        key: neobank/database
        property: password
    - secretKey: db_name
      remoteRef:
        key: neobank/database
        property: database
